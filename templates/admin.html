{% extends "layout.html" %}

{% block title %}Admin - Obelisk Stamps{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-body text-center">
                <img src="/user/picture/{{ current_user.id }}" alt="Profile Picture"
                     class="rounded-circle mb-3"
                     style="width: 120px; height: 120px; object-fit: cover;"
                     onerror="this.src='https://via.placeholder.com/120?text={{ current_user.name[0] }}'">
                <h5 class="card-title mb-1">{{ current_user.name }}</h5>
            </div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item">
                    <a href="/account" class="text-decoration-none d-flex align-items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="me-3 flex-shrink-0" viewBox="0 0 16 16">
                            <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0m4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4m-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664z"/>
                        </svg>
                        My Account
                    </a>
                </li>
                <li class="list-group-item">
                    <a href="/album" class="text-decoration-none d-flex align-items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="me-3 flex-shrink-0" viewBox="0 0 16 16">
                            <path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5zm6.5.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5zM1 10.5A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5zm6.5.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5z"/>
                        </svg>
                        My Album
                    </a>
                </li>
                <li class="list-group-item">
                    <a href="/orders" class="text-decoration-none d-flex align-items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="me-3 flex-shrink-0" viewBox="0 0 16 16">
                            <path d="M0 2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 3H.5a.5.5 0 0 1-.5-.5M3.14 5l1.25 5h8.22l1.25-5H3.14zM5 13a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0m9-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0"/>
                        </svg>
                        My Orders
                    </a>
                </li>
                <li class="list-group-item">
                    <a href="/account/settings" class="text-decoration-none d-flex align-items-center text-muted">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="me-3 flex-shrink-0" viewBox="0 0 16 16">
                            <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"/>
                        </svg>
                        Settings
                        <span class="badge bg-secondary ms-2">Coming Soon</span>
                    </a>
                </li>
                <li class="list-group-item active-sidebar">
                    <a href="/admin" class="text-decoration-none d-flex align-items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="me-3 flex-shrink-0" viewBox="0 0 16 16">
                            <path d="M5 0a.5.5 0 0 1 .5.5V2h1V.5a.5.5 0 0 1 1 0V2h1V.5a.5.5 0 0 1 1 0V2h1V.5a.5.5 0 0 1 1 0V2A2.5 2.5 0 0 1 14 4.5h1.5a.5.5 0 0 1 0 1H14v1h1.5a.5.5 0 0 1 0 1H14v1h1.5a.5.5 0 0 1 0 1H14v1h1.5a.5.5 0 0 1 0 1H14a2.5 2.5 0 0 1-2.5 2.5v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14A2.5 2.5 0 0 1 2 11.5H.5a.5.5 0 0 1 0-1H2v-1H.5a.5.5 0 0 1 0-1H2v-1H.5a.5.5 0 0 1 0-1H2v-1H.5a.5.5 0 0 1 0-1H2A2.5 2.5 0 0 1 4.5 2V.5A.5.5 0 0 1 5 0m-.5 3A1.5 1.5 0 0 0 3 4.5v7A1.5 1.5 0 0 0 4.5 13h7a1.5 1.5 0 0 0 1.5-1.5v-7A1.5 1.5 0 0 0 11.5 3h-7zM5 6.5A1.5 1.5 0 0 1 6.5 5h3A1.5 1.5 0 0 1 11 6.5v3A1.5 1.5 0 0 1 9.5 11h-3A1.5 1.5 0 0 1 5 9.5v-3zM6.5 6a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z"/>
                        </svg>
                        Admin Panel
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <a class="nav-link {% if active_tab == 'currency' %}active{% endif %}" href="/admin/currency">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                        <path d="M4 10.781c.148 1.667 1.513 2.85 3.591 3.003V15h1.043v-1.216c2.27-.179 3.678-1.438 3.678-3.3 0-1.59-.947-2.51-2.956-3.028l-.722-.187V3.467c1.122.11 1.879.714 2.07 1.616h1.47c-.166-1.6-1.54-2.748-3.54-2.875V1H7.591v1.233c-1.939.23-3.27 1.472-3.27 3.156 0 1.454.966 2.483 2.661 2.917l.61.162v4.031c-1.149-.17-1.94-.8-2.131-1.718H4zm3.391-3.836c-1.043-.263-1.6-.825-1.6-1.616 0-.944.704-1.641 1.8-1.828v3.495l-.2-.05zm1.591 1.872c1.287.323 1.852.859 1.852 1.769 0 1.097-.826 1.828-2.2 1.939V8.73l.348.086z"/>
                    </svg>
                    Currency Exchange
                </a>
            </li>
        </ul>

        {% if active_tab == 'currency' %}
        <!-- Currency Exchange Tab Content -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Current Exchange Rates</h5>
                <small class="text-muted">Base currency: EUR</small>
            </div>
            <div class="card-body">
                <!-- Active Rates Table -->
                <div class="table-responsive mb-3">
                    <table class="table table-hover mb-0" id="rates-table">
                        <thead class="table-light">
                            <tr>
                                <th>Currency</th>
                                <th>Rate (per 1 EUR)</th>
                                <th>Source</th>
                                <th>Last Updated</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="table-secondary">
                                <td><strong>EUR</strong></td>
                                <td>1.000000</td>
                                <td>base</td>
                                <td>-</td>
                            </tr>
                            {% for rate in rates %}
                            <tr>
                                <td><strong>{{ rate[0] }}</strong></td>
                                <td>{{ "%.6f"|format(rate[1]) }}</td>
                                <td><span class="badge {% if rate[2] == 'ecb' %}bg-success{% else %}bg-secondary{% endif %}">{{ rate[2] }}</span></td>
                                <td>{{ rate[3].strftime('%d %b %Y %H:%M') if rate[3] else 'N/A' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Action Buttons -->
                <div class="d-flex gap-2 flex-wrap">
                    <button type="button" class="btn btn-primary" id="btn-fetch-ecb" onclick="fetchEcbRates()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                        </svg>
                        Fetch from ECB
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#manual-entry">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                            <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                            <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
                        </svg>
                        Manual Entry
                    </button>
                </div>

                <!-- ECB Fetch Preview (hidden by default) -->
                <div class="mt-3 d-none" id="ecb-preview">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <span>ECB Rates Preview</span>
                            <small id="ecb-preview-date"></small>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm mb-3">
                                    <thead>
                                        <tr>
                                            <th>Currency</th>
                                            <th>New Rate</th>
                                            <th>Current Rate</th>
                                            <th>Change</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ecb-rates-body">
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-success" id="btn-save-ecb" onclick="saveEcbRates()">
                                    Save These Rates
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="dismissEcbPreview()">
                                    Dismiss
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manual Entry Form (collapsed) -->
                <div class="collapse mt-3" id="manual-entry">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Manual Rate Entry</h6>
                        </div>
                        <div class="card-body">
                            <form id="manual-rate-form" onsubmit="return saveManualRates(event)">
                                <div class="row g-3 mb-3">
                                    <div class="col-md-4">
                                        <label for="manual-currency" class="form-label">Currency Code</label>
                                        <input type="text" class="form-control" id="manual-currency" placeholder="e.g. USD" maxlength="3" pattern="[A-Za-z]{3}" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="manual-rate" class="form-label">Rate (per 1 EUR)</label>
                                        <input type="number" class="form-control" id="manual-rate" step="0.000001" min="0.000001" placeholder="e.g. 1.080000" required>
                                    </div>
                                    <div class="col-md-4 d-flex align-items-end">
                                        <button type="submit" class="btn btn-primary w-100">Save Rate</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Status message -->
                <div class="mt-3 d-none" id="status-message"></div>
            </div>
        </div>

        <!-- Rate History -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Rate History</h5>
            </div>
            <div class="card-body">
                {% if history %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Currency</th>
                                <th>Rate</th>
                                <th>Source</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in history %}
                            <tr>
                                <td>{{ entry[0] }}</td>
                                <td>{{ "%.6f"|format(entry[1]) }}</td>
                                <td><span class="badge {% if entry[2] == 'ecb' %}bg-success{% else %}bg-secondary{% endif %}">{{ entry[2] }}</span></td>
                                <td>{{ entry[3].strftime('%d %b %Y %H:%M') if entry[3] else 'N/A' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">No rate history available yet.</p>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Store current rates for comparison
const currentRates = {};
{% for rate in rates %}
currentRates['{{ rate[0] }}'] = {{ rate[1] }};
{% endfor %}

// Store fetched ECB rates for saving
let pendingEcbRates = null;

function showStatus(message, type) {
    const el = document.getElementById('status-message');
    el.className = `mt-3 alert alert-${type}`;
    el.textContent = message;
    el.classList.remove('d-none');
    setTimeout(() => el.classList.add('d-none'), 5000);
}

function fetchEcbRates() {
    const btn = document.getElementById('btn-fetch-ecb');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Fetching...';

    fetch('/admin/currency/fetch', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;

            if (!data.success) {
                showStatus('Failed to fetch ECB rates: ' + (data.error || 'Unknown error'), 'danger');
                return;
            }

            pendingEcbRates = data.rates;

            // Build the comparison table
            const tbody = document.getElementById('ecb-rates-body');
            tbody.innerHTML = '';

            for (const [currency, newRate] of Object.entries(data.rates)) {
                const oldRate = currentRates[currency];
                let changeHtml = '<span class="text-muted">new</span>';
                if (oldRate !== undefined) {
                    const diff = newRate - oldRate;
                    const pct = ((diff / oldRate) * 100).toFixed(3);
                    if (diff > 0) {
                        changeHtml = `<span class="text-success">+${pct}%</span>`;
                    } else if (diff < 0) {
                        changeHtml = `<span class="text-danger">${pct}%</span>`;
                    } else {
                        changeHtml = '<span class="text-muted">no change</span>';
                    }
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${currency}</strong></td>
                    <td>${newRate.toFixed(6)}</td>
                    <td>${oldRate !== undefined ? oldRate.toFixed(6) : '-'}</td>
                    <td>${changeHtml}</td>
                `;
                tbody.appendChild(row);
            }

            document.getElementById('ecb-preview-date').textContent = new Date().toLocaleDateString();
            document.getElementById('ecb-preview').classList.remove('d-none');
        })
        .catch(err => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            showStatus('Network error fetching ECB rates: ' + err.message, 'danger');
        });
}

function saveEcbRates() {
    if (!pendingEcbRates) return;

    const btn = document.getElementById('btn-save-ecb');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Saving...';

    fetch('/admin/currency/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rates: pendingEcbRates, source: 'ecb' })
    })
    .then(r => r.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = originalHtml;

        if (data.success) {
            showStatus(data.message || 'Rates saved successfully!', 'success');
            // Reload the page to show updated rates
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showStatus('Failed to save rates: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
        showStatus('Network error saving rates: ' + err.message, 'danger');
    });
}

function dismissEcbPreview() {
    document.getElementById('ecb-preview').classList.add('d-none');
    pendingEcbRates = null;
}

function saveManualRates(event) {
    event.preventDefault();

    const currency = document.getElementById('manual-currency').value.toUpperCase().trim();
    const rate = parseFloat(document.getElementById('manual-rate').value);

    if (!currency || currency.length !== 3) {
        showStatus('Please enter a valid 3-letter currency code.', 'warning');
        return false;
    }
    if (isNaN(rate) || rate <= 0) {
        showStatus('Please enter a valid positive rate.', 'warning');
        return false;
    }

    const rates = {};
    rates[currency] = rate;

    fetch('/admin/currency/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rates: rates, source: 'manual' })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showStatus(`Rate saved: 1 EUR = ${rate.toFixed(6)} ${currency}`, 'success');
            // Clear the form
            document.getElementById('manual-currency').value = '';
            document.getElementById('manual-rate').value = '';
            // Reload to show updated table
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showStatus('Failed to save rate: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(err => {
        showStatus('Network error: ' + err.message, 'danger');
    });

    return false;
}
</script>
{% endblock %}
