<!-- Stamp Identifier JavaScript -->
<!-- Usage: include 'partials/_stamp_identifier_scripts.html' in the scripts block -->

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('stamp-upload-form');
    const imageInput = document.getElementById('stamp-image');
    const previewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const resultsSection = document.getElementById('results-section');
    const resultsContainer = document.getElementById('results-container');
    const errorSection = document.getElementById('error-section');
    const errorMessage = document.getElementById('error-message');
    const identifyBtn = document.getElementById('identify-btn');
    const btnText = document.getElementById('btn-text');
    const btnSpinner = document.getElementById('btn-spinner');

    if (!form) return; // Exit if stamp identifier is not on this page

    // Image preview
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                previewContainer.classList.remove('d-none');
            };
            reader.readAsDataURL(file);
        } else {
            previewContainer.classList.add('d-none');
        }
    });

    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Reset state
        resultsSection.classList.add('d-none');
        errorSection.classList.add('d-none');

        // Show loading state
        identifyBtn.disabled = true;
        btnText.textContent = 'Identifying...';
        btnSpinner.classList.remove('d-none');

        const formData = new FormData();
        formData.append('image', imageInput.files[0]);
        formData.append('currency', document.getElementById('currency').value);

        try {
            const response = await fetch('/predict', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Unknown error occurred');
            }

            // Display results
            displayResults(data);

        } catch (error) {
            errorMessage.textContent = error.message;
            errorSection.classList.remove('d-none');
        } finally {
            // Reset button state
            identifyBtn.disabled = false;
            btnText.textContent = 'Identify Stamp';
            btnSpinner.classList.add('d-none');
        }
    });

    function displayResults(data) {
        resultsContainer.innerHTML = '';

        // Check if this is a multi-stamp response
        if (data.multi_stamp && data.stamps) {
            displayMultiStampResults(data);
            return;
        }

        // Single stamp: data is an array of matches (original behavior)
        const results = Array.isArray(data) ? data : [];

        if (results.length === 0) {
            resultsContainer.innerHTML = '<div class="col-12"><p class="text-muted">No matches found.</p></div>';
            resultsSection.classList.remove('d-none');
            return;
        }

        displaySingleStampMatches(results);
        resultsSection.classList.remove('d-none');
    }

    function displayMultiStampResults(data) {
        const header = document.createElement('div');
        header.className = 'col-12 mb-3';
        header.innerHTML = `
            <div class="alert alert-info">
                <strong>${data.stamp_count} stamps detected</strong> in this image.
                Each stamp is shown below with its top matches.
            </div>
        `;
        resultsContainer.appendChild(header);

        // Get the original uploaded image to crop stamps from
        const originalImage = imagePreview;

        data.stamps.forEach((stamp, stampIndex) => {
            // Stamp section wrapper
            const stampSection = document.createElement('div');
            stampSection.className = 'col-12 mb-4';

            // Create cropped image from bbox using canvas
            const croppedImageUrl = cropStampFromImage(originalImage, stamp.bbox);

            // Stamp header with cropped image
            const stampHeader = document.createElement('div');
            stampHeader.className = 'row align-items-center mb-3 pb-2 border-bottom';
            stampHeader.innerHTML = `
                <div class="col-auto">
                    <img src="${croppedImageUrl}" alt="Stamp ${stampIndex + 1}"
                         class="img-thumbnail" style="max-height: 120px; max-width: 120px;">
                </div>
                <div class="col">
                    <h4 class="mb-1">Stamp ${stampIndex + 1} of ${data.stamp_count}</h4>
                    <span class="text-muted">Detection confidence: ${(stamp.detection_confidence * 100).toFixed(1)}%</span>
                </div>
            `;
            stampSection.appendChild(stampHeader);

            // Show only the best match for this stamp
            if (stamp.matches && stamp.matches.length > 0) {
                const result = stamp.matches[0];
                const similarity = (result.similarity * 100).toFixed(1);
                const price = result.price_converted ?
                    `${result.price_converted.value.toFixed(2)} ${result.price_converted.currency}` :
                    'N/A';

                // Store result data for the add-to-album button
                const stampData = {
                    image_base64: croppedImageUrl,
                    title: result.title,
                    country: result.country,
                    year: result.year,
                    condition_text: result.condition_text,
                    price_value: result.price_converted?.value || result.price_value,
                    price_currency: result.price_converted?.currency || result.price_currency,
                    source_url: result.source_url,
                    similarity: result.similarity
                };

                const matchCard = document.createElement('div');
                matchCard.className = 'row';
                matchCard.innerHTML = `
                    <div class="col-md-6">
                        <div class="card h-100 border-primary">
                            <div class="card-header bg-primary text-white">
                                <strong>Best Match</strong>
                                <span class="badge bg-light text-primary float-end">${similarity}%</span>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">${result.title || 'Unknown'}</h5>
                                <ul class="list-unstyled mb-0">
                                    <li><strong>Country:</strong> ${result.country || 'N/A'}</li>
                                    <li><strong>Year:</strong> ${result.year || 'N/A'}</li>
                                    <li><strong>Condition:</strong> ${result.condition_text || 'N/A'}</li>
                                    <li><strong>Price:</strong> <span class="text-success fw-bold">${price}</span></li>
                                </ul>
                            </div>
                            <div class="card-footer">
                                <div class="d-flex gap-2">
                                    <a href="${result.source_url || '#'}" target="_blank" class="btn btn-sm btn-outline-primary flex-grow-1">
                                        View on PostBeeld
                                    </a>
                                    ${window.userIsAuthenticated ? `
                                    <button type="button" class="btn btn-sm btn-success add-to-album-btn" data-stamp='${JSON.stringify(stampData).replace(/'/g, "&#39;")}'>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                                        </svg>
                                        Album
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                stampSection.appendChild(matchCard);
            } else {
                const noMatch = document.createElement('p');
                noMatch.className = 'text-muted';
                noMatch.textContent = 'No matches found for this stamp.';
                stampSection.appendChild(noMatch);
            }

            resultsContainer.appendChild(stampSection);
        });

        resultsSection.classList.remove('d-none');
    }

    function cropStampFromImage(imgElement, bbox) {
        // bbox is [x1, y1, x2, y2] in original image coordinates
        const [x1, y1, x2, y2] = bbox;
        const cropWidth = x2 - x1;
        const cropHeight = y2 - y1;

        // Create a canvas to crop the image
        const canvas = document.createElement('canvas');
        canvas.width = cropWidth;
        canvas.height = cropHeight;
        const ctx = canvas.getContext('2d');

        // Draw the cropped portion using natural dimensions
        ctx.drawImage(
            imgElement,
            x1, y1, cropWidth, cropHeight,  // Source rectangle (original coords)
            0, 0, cropWidth, cropHeight      // Destination rectangle
        );

        return canvas.toDataURL('image/jpeg', 0.9);
    }

    function displaySingleStampMatches(results) {
        // Only show the first (best) match
        if (results.length === 0) return;

        const result = results[0];
        const similarity = (result.similarity * 100).toFixed(1);
        const price = result.price_converted ?
            `${result.price_converted.value.toFixed(2)} ${result.price_converted.currency}` :
            'N/A';

        // Get the uploaded image as base64 for the album
        const stampData = {
            image_base64: imagePreview.src,
            title: result.title,
            country: result.country,
            year: result.year,
            condition_text: result.condition_text,
            price_value: result.price_converted?.value || result.price_value,
            price_currency: result.price_converted?.currency || result.price_currency,
            source_url: result.source_url,
            similarity: result.similarity
        };

        const card = document.createElement('div');
        card.className = 'col-md-6 mb-3';
        card.innerHTML = `
            <div class="card h-100 border-primary">
                <div class="card-header bg-primary text-white">
                    <strong>Best Match</strong>
                    <span class="badge bg-light text-primary float-end">${similarity}%</span>
                </div>
                <div class="card-body">
                    <h5 class="card-title">${result.title || 'Unknown'}</h5>
                    <ul class="list-unstyled mb-0">
                        <li><strong>Country:</strong> ${result.country || 'N/A'}</li>
                        <li><strong>Year:</strong> ${result.year || 'N/A'}</li>
                        <li><strong>Condition:</strong> ${result.condition_text || 'N/A'}</li>
                        <li><strong>Price:</strong> <span class="text-success fw-bold">${price}</span></li>
                    </ul>
                </div>
                <div class="card-footer">
                    <div class="d-flex gap-2">
                        <a href="${result.source_url || '#'}" target="_blank" class="btn btn-sm btn-outline-primary flex-grow-1">
                            View on PostBeeld
                        </a>
                        ${window.userIsAuthenticated ? `
                        <button type="button" class="btn btn-sm btn-success add-to-album-btn" data-stamp='${JSON.stringify(stampData).replace(/'/g, "&#39;")}'>
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                            </svg>
                            Album
                        </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
        resultsContainer.appendChild(card);
    }

    // Handle Add to Album button clicks
    document.addEventListener('click', async function(e) {
        if (e.target.closest('.add-to-album-btn')) {
            const btn = e.target.closest('.add-to-album-btn');
            const stampData = JSON.parse(btn.dataset.stamp);

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            try {
                const response = await fetch('/album/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(stampData)
                });

                const data = await response.json();

                if (response.ok) {
                    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/></svg> Added!';
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-secondary');
                } else {
                    throw new Error(data.error || 'Failed to add stamp');
                }
            } catch (error) {
                alert('Error adding stamp to album: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/></svg> Album';
            }
        }
    });
});
</script>
